# CLAUDE.md - AI開発アシスタントのためのガイドライン

このファイルは、Claude（AI開発アシスタント）がこのプロジェクトで作業を行う際に従うべきルールとガイドラインを定義します。

## 目的

- 開発作業の一貫性を保つ
- ユーザーの意図を尊重する
- 予期しない変更を防ぐ
- Git操作の透明性を確保する

## Git操作に関するルール

### 1. ブランチ戦略

作業を開始する際は、**必ず新しいブランチを作成**してから作業を行うこと。

#### ブランチ命名規則

ブランチ名は以下のプレフィックスを使用：

- `add/機能名` - 新しい機能を追加する場合
- `modify/機能名` - 既存機能を変更する場合
- `fix/バグ名` - バグを修正する場合
- `docs/ドキュメント名` - ドキュメントを更新する場合

**例**:
```
add/user-authentication
modify/chart-colors
fix/calculation-error
docs/update-readme
```

### 2. 作業フロー

#### ステップ1: ブランチ作成
```bash
git checkout main
git pull origin main
git checkout -b [プレフィックス]/[機能名]
```

#### ステップ2: コード変更
- ファイルの編集を行う
- 必要に応じて複数のファイルを変更

#### ステップ3: ローカル動作確認（必須）
**重要**: すべての変更について、ローカル環境で動作確認を行うこと。

```bash
# 開発サーバーを起動
bin/rails server

# ブラウザで http://localhost:3000 にアクセス
```

以下を確認：
- [ ] アプリケーションが正常に起動する
- [ ] エラーが発生しない
- [ ] 変更した機能が正しく動作する
- [ ] **UIやレイアウトの変更がある場合は、必ずブラウザで表示を確認する**
  - デスクトップ表示の確認
  - モバイル表示の確認（ブラウザの開発者ツールで確認）
  - 変更前後の比較
  - レスポンシブ対応の確認

**ユーザーに確認してもらう際の推奨事項**:
- スクリーンショットを撮影して共有
- 変更箇所を具体的に説明
- 期待される動作と実際の動作を報告

#### ステップ4: Lint/セキュリティチェック
```bash
bundle exec rubocop
bundle exec brakeman
```

#### ステップ5: ユーザーに変更を確認してもらう
**重要**: git add, commit, push を実行する前に、**必ずユーザーに変更内容を確認してもらうこと**。

以下の情報を提示：
- 変更されたファイル一覧
- 主な変更内容の説明
- 動作確認結果
  - エラーの有無
  - 機能の動作確認
  - **UIやレイアウトの変更がある場合は、ローカル環境（http://localhost:3000）でユーザー自身が確認できるよう案内する**
- Lint/セキュリティチェック結果

**UIやレイアウト変更時の追加事項**:
```
現在、ローカルサーバーが起動しています（http://localhost:3000）。
ブラウザでアクセスして、以下の変更点をご確認ください：

1. [変更箇所1の説明]
2. [変更箇所2の説明]

デスクトップとモバイル表示の両方をご確認いただき、
問題なければ承認をお願いします。
```

ユーザーの承認を得てから次のステップに進むこと。

#### ステップ6: Git操作（ユーザー承認後）
```bash
git add .
git commit -m "[プレフィックス]: 変更内容の説明"
git push -u origin [ブランチ名]
```

### 3. コミットメッセージのルール

#### 形式
```
[プレフィックス]: 変更内容の簡潔な説明

- 詳細な変更内容1
- 詳細な変更内容2
- 詳細な変更内容3

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

#### プレフィックスの種類
- `Add:` - 新機能の追加
- `Modify:` - 既存機能の変更
- `Fix:` - バグ修正
- `Docs:` - ドキュメント更新
- `Refactor:` - リファクタリング
- `Test:` - テストの追加・修正
- `Chore:` - ビルドプロセスやツールの変更

#### 良いコミットメッセージの例
```
Add: ユーザー認証機能を追加

- Deviseを導入してユーザーモデルを作成
- ログイン・ログアウト機能を実装
- 認証が必要なページに制限を追加
```

```
Fix: CO2排出量の計算エラーを修正

- 小数点以下の丸め処理を修正
- テストケースを追加して検証
```

```
Docs: 初心者向けにREADME.mdを更新

- 環境構築手順を詳細化
- Git操作のステップを追加
- トラブルシューティングセクションを追加
```

### 4. プッシュ前の確認事項

以下をすべて確認してからプッシュすること：

- [ ] ローカルで動作確認済み
  - [ ] アプリケーションが正常に起動する
  - [ ] 変更した機能が正しく動作する
  - [ ] **UIやレイアウトの変更がある場合、ユーザーがローカル環境（http://localhost:3000）で実際に確認済み**
- [ ] `bundle exec rubocop` が通る（エラー0件）
- [ ] `bundle exec brakeman` でセキュリティ警告なし
- [ ] コミットメッセージが規則に従っている
- [ ] **ユーザーが変更内容を確認・承認済み**

### 5. プルリクエスト作成時

プルリクエスト作成後、以下を確認：

1. GitHub ActionsのCI/CDが緑色（成功）になっているか
2. コンフリクトがないか
3. 変更内容が意図通りか

問題があれば、修正してから再度プッシュ。

## コーディング規約

### Ruby/Railsのスタイル

- RuboCopのルールに従う
- 自動修正可能な問題は `bundle exec rubocop -A` で修正

### セキュリティ

- Brakemanで警告が出ないこと
- 機密情報（API キー、パスワードなど）をコードに含めない
- 環境変数を使用する

### コメント

- 複雑なロジックには日本語でコメントを追加
- 初心者が理解しやすいように説明を記載

## ファイル操作に関するルール

### 作成禁止ファイル

以下のファイルは**明示的な指示がない限り作成しない**こと：

- マークダウンドキュメント（README.md以外）
- 設定ファイルの不要な複製
- 一時ファイル

### 削除に注意が必要なファイル

以下のファイルを削除する際は**必ずユーザーに確認**すること：

- データベースマイグレーションファイル
- 設定ファイル（config/配下）
- 環境ファイル（.env, master.key など）

## CI/CDに関するルール

### GitHub Actionsの確認

プッシュ後、以下を確認：

1. RuboCopチェックが通ること
2. Brakemanチェックが通ること
3. すべてのワークフローが成功すること

### CI/CDが失敗した場合

1. エラーログを確認
2. ローカルで同じチェックを実行
3. 問題を修正
4. 再度コミット・プッシュ

## デプロイに関するルール

### ステージング環境（Render）

- mainブランチへのマージ時に自動デプロイ
- デプロイ完了後、動作確認を推奨

### 本番環境（AWS）

- 将来的にAWSへの移行を予定
- データベースをPostgreSQLに移行する必要あり

## 初心者への配慮

### 説明の追加

コード変更時は、以下を意識すること：

- なぜその変更が必要か
- どのような影響があるか
- 関連する概念の説明（初心者向け）

### ドキュメントの更新

大きな変更を行った場合は、README.mdも更新すること：

- 新しい機能の使い方
- 変更による影響
- 必要に応じて図やスクリーンショットを追加

## トラブルシューティング

### よくある問題と対処法

#### RuboCopエラー
```bash
bundle exec rubocop -A  # 自動修正
```

#### Brakemanの警告
- 警告内容を確認
- セキュリティリスクを評価
- 必要に応じて修正

#### Gitコンフリクト
1. mainブランチを最新化
2. マージしてコンフリクトを解決
3. 解決後にコミット

## 禁止事項

以下の操作は**絶対に行わない**こと：

1. ユーザーの承認なしでの `git push`
2. ユーザーの承認なしでの `git push --force`
3. mainブランチへの直接コミット
4. master.keyやシークレット情報のコミット
5. データベースファイル（*.sqlite3）のコミット
6. 大量のファイルの無差別削除

## まとめ

このガイドラインの目的は、**ユーザーとAIが協力して、安全で効率的な開発を行う**ことです。

### 最も重要なルール

> **Git操作（add, commit, push）を実行する前に、必ずユーザーに変更内容を確認してもらい、承認を得ること。**

このルールを守ることで、予期しない変更やエラーを防ぎ、ユーザーが安心して開発を進められるようにします。

---

**このファイルは定期的に更新されます。**
新しいルールやガイドラインが追加された際は、このファイルを参照してください。
